<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    	<!-- Load plotly.js into the DOM -->
	<script src='https://cdn.plot.ly/plotly-latest.min.js'></script>

</head>
<body>
    <div id="myDiv"></div>

    <div id="myDiv2"></div>



    <script>
        //Todo: 


        //Add Datasert Template here
        var candleStick = {
            //X-Axis
            x: [],//String Value 
            
            //Y-Axis
            close: [],//Number Value 
            
            high: [],//Number Value 
            
            line: {color: 'rgba(31,119,180,1)'}, 
            
            low: [],//Number Value 
            
            open: [],//Number Value 

            //Config
            type: 'candlestick', 
            xaxis: 'x', 
            yaxis: 'y'
        };

        var line = {
            x: [

            ],
            y: [

            ],
            mode: 'lines',
            type: 'scatter'
        };

        var data = [
            candleStick,  
            // line
        ];//Choose which Trace gets rendered on the chart(multiple traces can be rendered)

        var layout2 = {
            xaxis: {
                range: [ Math.min(line.x), Math.max(line.x) ]
            },
            yaxis: {
                range: [Math.min(line.y), Math.max(line.y)]
            },
            // legend: {
            //     y: 0.5,
            //     yref: 'paper',
            //     font: {
            //     family: 'Arial, sans-serif',
            //     size: 20,
            //     color: 'grey',
            //     }
            // },
            title:'Data Labels on the Plot'
        };

        var layout = {
        dragmode: 'zoom', 
            margin: {
                r: 10, 
                t: 25, 
                b: 40, 
                l: 60
            }, 
            showlegend: false, 
            xaxis: {
                autorange: true, 
                domain: [0, 1], 
                range: [candleStick.x[0],candleStick.x[candleStick.x.length-1]], //Chart Range
                rangeslider: {range: [candleStick.x[0],candleStick.x[candleStick.x.length-1]]}, //RangeSlider Range
                title: 'Date', 
                type: 'date'
            }, 
            yaxis: {
                autorange: true, 
                domain: [0, 1], 
                type: 'linear'
            }
        };
        
        let ChartJSgenerator = async function () {
            
            const response = await fetch("https://www.binance.com/api/v3/klines?symbol=ETHUSDT&interval=1d");
            const answer = await response.json();
            for (element of answer){
                candleStick.x.push(new Date(element[0]).toISOString().split('T')[0])
                candleStick.high.push(parseFloat(element[2]))
                candleStick.low.push(parseFloat(element[3]))
                candleStick.open.push(parseFloat(element[1]))
                candleStick.close.push(parseFloat(element[4]))
            };
            
            // console.log('xaxis: ',candleStick.x);









                                                //Make API-Call
                                                let APIanswer = async function(){
                                                    let answer = await fetch('http://localhost:5003/position2')
                                                    .then(res => res.json())
                                                    .catch (error => console.log('Error Report: ',error))
                                                    //This is not ideal
                                                    return answer;
                                                }

                                                let HistoricalPriceFormater = async function (api_answer){
                                                    let res = await api_answer;
                                                    // console.log(res.answer.result.XETHZUSD);
                                                    let PriceSourceArray = [];
                                                        for (const element of answer) 
                                                                { 
                                                                    let dateobject = new Date(element[0] )
                                                                    let preishigh = parseFloat(element[2])
                                                                    let preislow = parseFloat(element[3])
                                                                    PriceSourceArray.push([((preishigh + preislow) / 2), dateobject.toISOString().split("T")[0]])  
                                                                };
                                                    return PriceSourceArray;
                                                };



                                                let forEacher = async (formater, answer, length) => { //function reference
                                                    let pricaArray = await formater(answer()) // function invocation
                                                    let globalReturn = {
                                                        x : [],
                                                        y : []
                                                    }
                                                    pricaArray.forEach(item =>{ 
                                                        let index = pricaArray.indexOf(item)
                                                    
                                                        let TagesDaten = []

                                                        //Add the last X(days, weeks, hours, whatever) datapoints together and 
                                                        //push them into the Array
                                                        for(let i=0; i<length; i++) {
                                                            const dayData = pricaArray[index-i]
                                                            if (typeof dayData !== 'undefined' ) {
                                                                TagesDaten.push(Math.trunc(dayData[0]))  
                                                            }
                                                        }
                                                        let sum = null;

                                                        //Take the Array and calculate an average Value from all elements
                                                        if (TagesDaten.length >= length) {
                                                            for (var i = 0; i < length; i++) { 
                                                                    sum += TagesDaten[i] 
                                                                        
                                                            }
                                                            //Pushing the Data to the globalReturn Array (inside forEacher)
                                                            globalReturn.x.push(
                                                                //Changing Date Format
                                                                
                                                               pricaArray[index][1]
                                                            )
                                                            globalReturn.y.push(
                                                                Math.trunc(sum/length)
                                                            )

                                                            //Alternatively pushing it directly to the global line Object
                                                            line.x.push(pricaArray[index][1])
                                                            line.y.push(Math.trunc(sum/length))
                                                        }   
                                                    })
                                                    
                                                    console.log(line);
                                                    console.log(candleStick);
                                                    return globalReturn
                                                }

                                                // forEacher(HistoricalPriceFormater, APIanswer ,20)()

                                                async function logforEacher(data){
                                                   await data(HistoricalPriceFormater, APIanswer ,20)
                                                }
                                                logforEacher(forEacher)










                                        

            Plotly.newPlot('myDiv', data, layout);

            Plotly.newPlot('myDiv2', line, layout);
        }
        ChartJSgenerator()
       
        </script>






</body>
</html>